#!/usr/bin/env bash

set -euo pipefail

BIGIP_FILE="devices.txt"
CURL_OPTS=(-sS -k --connect-timeout 10 --max-time 25)
CONTENT_TYPE="Content-Type: application/json"

for bin in curl jq expect sshpass; do
  command -v "$bin" >/dev/null || { echo "‚ùå $bin requis"; exit 1; }
done

[[ -f "$BIGIP_FILE" ]] || { echo "‚ùå devices.txt introuvable"; exit 1; }

read -rp "Utilisateur : " API_USER
read -s -rp "Mot de passe : " API_PASS
echo
read -s -rp "NOUVEAU mot de passe ROOT : " ROOT1
echo
read -s -rp "NOUVEAU mot de passe ADMIN: " ADMIN1
echo

ADMIN_JSON=$(jq -n --arg pwd "$ADMIN1" '{password: $pwd}')

#######################################
# HA DETECTION
#######################################
get_cluster_mode() {
  local host="$1"

  local count
  count=$(curl "${CURL_OPTS[@]}" -u "${API_USER}:${API_PASS}" \
    "https://${host}/mgmt/tm/cm/device-group?\$select=type" 2>/dev/null \
    | jq '[.items[]? | select(.type=="sync-failover")] | length' 2>/dev/null || echo 0)

  if [[ "$count" -eq 0 ]]; then
    echo "STANDALONE"
  else
    echo "CLUSTER"
  fi
}

get_role() {
  local host="$1"

  curl "${CURL_OPTS[@]}" -u "${API_USER}:${API_PASS}" \
    "https://${host}/mgmt/tm/cm/failover-status/stats" 2>/dev/null \
  | jq -r '
      [ .. | strings | select(test("ACTIVE|STANDBY";"i")) ][0] // "UNKNOWN"
    ' 2>/dev/null | head -n1
}

#######################################
# MAIN
#######################################
echo
echo "üîê Changement mot de passe (ACTIVE ou STANDALONE uniquement)"
echo

while IFS= read -r LINE || [[ -n "$LINE" ]]; do
  F5_HOST=$(echo "$LINE" | tr -d '\r' | xargs)
  [[ -z "$F5_HOST" || "$F5_HOST" =~ ^# ]] && continue

  echo "======================================"
  echo "‚û°Ô∏è  BIG-IP : $F5_HOST"
  echo "======================================"

  MODE=$(get_cluster_mode "$F5_HOST")
  echo "Mode : $MODE"

  if [[ "$MODE" == "CLUSTER" ]]; then
    ROLE=$(get_role "$F5_HOST")
    echo "Role : $ROLE"

    if ! grep -qi "ACTIVE" <<<"$ROLE"; then
      echo "‚ÑπÔ∏è  Cluster mais non-ACTIVE => skip"
      echo
      continue
    fi
  else
    echo "Standalone => modification autoris√©e"
  fi

  ###################################
  # ADMIN
  ###################################
  echo "üîÅ ADMIN"
  curl "${CURL_OPTS[@]}" \
    -u "${API_USER}:${API_PASS}" \
    -X PATCH \
    -H "$CONTENT_TYPE" \
    -d "$ADMIN_JSON" \
    "https://${F5_HOST}/mgmt/tm/auth/user/admin" \
    >/dev/null

  ###################################
  # ROOT
  ###################################
  echo "üîÅ ROOT"

  expect -f - <<'EOF' "$API_USER" "$API_PASS" "$F5_HOST" "$ROOT1" >/dev/null
set API_USER [lindex $argv 0]
set API_PASS [lindex $argv 1]
set F5_HOST [lindex $argv 2]
set ROOT1 [lindex $argv 3]

set timeout 30
spawn sshpass -p "$API_PASS" ssh -tt \
  -o StrictHostKeyChecking=no \
  -o ConnectTimeout=20 \
  -o LogLevel=Error \
  $API_USER@$F5_HOST

expect {
  -re {\(tmos\)#} {
    send "bash\r"
    exp_continue
  }
  -re {[\$#]} {}
}

send "tmsh modify auth password root\r"
expect -re "(?i)new password:"
send -- "$ROOT1\r"
expect -re "(?i)confirm password:"
send -- "$ROOT1\r"

send "exit\r"
send "quit\r"
expect eof
EOF

  echo "‚úÖ Modification effectu√©e"
  echo

done < "$BIGIP_FILE"

echo "üéØ Termin√©"
