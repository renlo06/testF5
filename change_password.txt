#!/usr/bin/env bash

#######################################
# SCRIPT METADATA
#######################################
SCRIPT_NAME="f5-password.sh"
SCRIPT_VERSION="1.1.0"
SCRIPT_DATE="2026-01-13"
SCRIPT_AUTHOR="lh12256"

#######################################
# VERSION OPTION
#######################################
if [[ "${1:-}" == "-v" || "${1:-}" == "--version" ]]; then
  echo "$SCRIPT_NAME version $SCRIPT_VERSION ($SCRIPT_DATE)"
  exit 0
fi

#######################################
# BASH SAFETY
#######################################
set -euo pipefail

#######################################
# CONFIG
#######################################
BIGIP_FILE="devices.txt"
CURL_OPTS="-sS -k"
CONTENT_TYPE="Content-Type: application/json"

#######################################
# PRECHECKS
#######################################
command -v curl >/dev/null || { echo "âŒ curl manquant"; exit 1; }
command -v jq   >/dev/null || { echo "âŒ jq requis"; exit 1; }

[[ -f "$BIGIP_FILE" ]] || {
  echo "âŒ Fichier $BIGIP_FILE introuvable"
  exit 1
}

#######################################
# HEADER
#######################################
echo "======================================"
echo " $SCRIPT_NAME"
echo " Version : $SCRIPT_VERSION"
echo " Date    : $SCRIPT_DATE"
echo " Auteur  : $SCRIPT_AUTHOR"
echo "======================================"
echo

#######################################
# INPUTS
#######################################
read -p "Utilisateur API (ex: admin): " API_USER
read -s -p "Mot de passe API actuel: " API_PASS
echo

# ADMIN
read -s -p "NOUVEAU mot de passe ADMIN: " ADMIN1
echo
read -s -p "Confirmer mot de passe ADMIN: " ADMIN2
echo
[[ "$ADMIN1" == "$ADMIN2" ]] || { echo "âŒ ADMIN mismatch"; exit 1; }

# ROOT
read -s -p "NOUVEAU mot de passe ROOT: " ROOT1
echo
read -s -p "Confirmer mot de passe ROOT: " ROOT2
echo
[[ "$ROOT1" == "$ROOT2" ]] || { echo "âŒ ROOT mismatch"; exit 1; }

#######################################
# JSON PAYLOADS (SAFE)
#######################################
ADMIN_JSON=$(jq -n --arg pwd "$ADMIN1" '{password: $pwd}')


#######################################
# MAIN LOOP
#######################################
echo
echo "ðŸ” DÃ©but du changement des mots de passe"
echo

while IFS= read -r F5_HOST; do
  # Skip comments / empty
  [[ -z "$F5_HOST" || "$F5_HOST" =~ ^# ]] && continue

  # CRLF protection
  F5_HOST=${F5_HOST//$'\r'/}

  echo "======================================"
  echo "âž¡ï¸  BIG-IP : $F5_HOST"
  echo "======================================"

  # ADMIN
  echo "ðŸ” Changement mot de passe ADMIN"
  curl $CURL_OPTS \
    -u "${API_USER}:${API_PASS}" \
    -X PATCH \
    -H "$CONTENT_TYPE" \
    -d "$ADMIN_JSON" \
    "https://${F5_HOST}/mgmt/tm/auth/user/admin" \
    >/dev/null

  #ROOT
  echo
  echo "ROOT"
  
  expect -f - <<'EOF' "$API_USER" "$API_PASS" "$F5_HOST" "$ROOT1" >/dev/null
  set API_USER [lindex $argv 0]
  set API_PASS [lindex $argv 1]
  set F5_HOST [lindex $argv 2]
  set ROOT1 [lindex $argv 3]
  
  set timeout 20
  spawn sshpass -p "$API_PASS" ssh -tt -o StrictHostKeyChecking=no -o ConnectTimeout=20 -o LogLevel=Error $API_USER@$F5_HOST
  
  expect{
	-re {\(tmos\)#} {
		send "bash\r"
		exp_continue
	}
	-re {[\$#]} {}
  }
  
  send "tmsh modify auth password root\r"
  expect -re "changing password for root"
  expect -re "(?i)new password:"
  after 500
  send -- "$ROOT1\r"
  expect -re "confirm password:"
  after 500
  send -- "$ROOT1\r"
  send "exit\r"
  send "quit\r"
  
  expect eof
  EOF
  
  echo "Done"

  # SAVE CONFIG
  echo "ðŸ’¾ Sauvegarde configuration"
  curl $CURL_OPTS \
    -u "${API_USER}:${API_PASS}" \
    -X POST \
    -H "$CONTENT_TYPE" \
    -d '{"command":"save"}' \
    "https://${F5_HOST}/mgmt/tm/sys/config" \
    >/dev/null

  echo "âœ… $F5_HOST terminÃ©"
  echo

done < "$BIGIP_FILE"

echo "ðŸŽ¯ Rotation terminÃ©e sur tous les Ã©quipements"
