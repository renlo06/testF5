#!/usr/bin/env bash
set -euo pipefail

#######################################
# CONFIG
#######################################
DEVICES_FILE="devices.txt"
CURL_OPTS=(-k -sS --connect-timeout 10 --max-time 20)

#######################################
# PRECHECKS
#######################################
for bin in curl jq awk tr grep wc; do
  command -v "$bin" >/dev/null || { echo "‚ùå $bin requis"; exit 1; }
done
[[ -f "$DEVICES_FILE" ]] || { echo "‚ùå Fichier √©quipements introuvable : $DEVICES_FILE"; exit 1; }

#######################################
# INPUTS
#######################################
read -rp "Utilisateur API (REST, ex: admin): " API_USER
read -s -rp "Mot de passe API (REST): " API_PASS
echo
AUTH=(-u "${API_USER}:${API_PASS}")

#######################################
# HELPERS
#######################################
trim_line() {
  printf "%s" "$1" | tr -d '\r' | awk '{$1=$1;print}'
}

# Teste un endpoint REST (HTTP 2xx = OK)
rest_ok() {
  local host="$1" path="$2"
  curl "${CURL_OPTS[@]}" "${AUTH[@]}" \
    --fail \
    "https://${host}${path}" >/dev/null 2>&1
}

# R√©cup√®re une valeur texte de sys db ui.advisory.text via REST
get_ui_advisory_text() {
  local host="$1"
  # endpoint typique : /mgmt/tm/sys/db/ui.advisory.text
  # selon versions, la valeur peut √™tre .value ou nestedStats.description
  curl "${CURL_OPTS[@]}" "${AUTH[@]}" \
    "https://${host}/mgmt/tm/sys/db/ui.advisory.text" 2>/dev/null \
  | jq -r '
      .value? //
      .defaultValue? //
      .valueString? //
      .nestedStats.entries.value.description? //
      .nestedStats.entries.defaultValue.description? //
      empty
    ' 2>/dev/null
}

#######################################
# MAIN
#######################################
TOTAL=$(grep -Ev '^\s*#|^\s*$' "$DEVICES_FILE" | wc -l | awk '{print $1}')
COUNT=0
FAILS=0

echo
echo "üîé Checks Orchestrated (AS3 / Service Discovery / Orchestrated Device)"
echo

while IFS= read -r LINE || [[ -n "$LINE" ]]; do
  HOST="$(trim_line "$LINE")"
  [[ -z "$HOST" || "$HOST" =~ ^# ]] && continue
  COUNT=$((COUNT+1))

  echo "======================================"
  echo "‚û°Ô∏è  [$COUNT/$TOTAL] BIG-IP : $HOST"
  echo "======================================"

  HOST_FAIL=0

  # 1) AS3 info
  if rest_ok "$HOST" "/mgmt/shared/appsvcs/info"; then
    echo "AS3                 : ‚úÖ OK"
  else
    echo "AS3                 : ‚ùå KO"
    HOST_FAIL=1
  fi

  # 2) Service Discovery task endpoint
  if rest_ok "$HOST" "/mgmt/shared/service-discovery/task"; then
    echo "Service Discovery   : ‚úÖ OK"
  else
    echo "Service Discovery   : ‚ùå KO"
    HOST_FAIL=1
  fi

  # 3) Orchestrated Device in ui.advisory.text
  ADV_TEXT="$(get_ui_advisory_text "$HOST" || true)"
  if [[ -n "${ADV_TEXT:-}" ]] && grep -qi "Orchestrated Device" <<<"$ADV_TEXT"; then
    echo "Orchestrated Device : ‚úÖ OK (ui.advisory.text)"
  else
    echo "Orchestrated Device : ‚ùå KO (ui.advisory.text)"
    HOST_FAIL=1
  fi

  if [[ "$HOST_FAIL" -eq 1 ]]; then
    FAILS=$((FAILS+1))
    echo "‚û°Ô∏è  Verdict $HOST : ‚ùå KO"
  else
    echo "‚û°Ô∏è  Verdict $HOST : ‚úÖ OK"
  fi

  echo
done < "$DEVICES_FILE"

echo "======================================"
echo "üèÅ Termin√©"
echo "√âquipements trait√©s : $COUNT"
echo "√âquipements en KO   : $FAILS"
echo "======================================"

# Exit code non-zero si au moins un KO, mais seulement √† la fin
(( FAILS == 0 )) || exit 1