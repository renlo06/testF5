#!/usr/bin/env bash
set -euo pipefail

#######################################
# CONFIG
#######################################
DEVICES_FILE="devices.txt"
CURL_OPTS=(-k -sS --fail)

#######################################
# PRECHECKS
#######################################
for bin in ssh sshpass curl grep awk wc tr; do
  command -v "$bin" >/dev/null || { echo "‚ùå $bin requis"; exit 1; }
done

[[ -f "$DEVICES_FILE" ]] || { echo "‚ùå Fichier √©quipements introuvable : $DEVICES_FILE"; exit 1; }

#######################################
# INPUTS
#######################################
read -rp "Utilisateur SSH (tmsh): " SSH_USER
read -s -rp "Mot de passe SSH: " SSH_PASS
echo

read -rp "Utilisateur API (REST): " API_USER
read -s -rp "Mot de passe API: " API_PASS
echo

AUTH=(-u "${API_USER}:${API_PASS}")

#######################################
# HELPERS
#######################################
check_rest() {
  local host="$1"
  local endpoint="$2"

  if curl "${CURL_OPTS[@]}" "${AUTH[@]}" \
       "https://${host}${endpoint}" >/dev/null 2>&1; then
    echo "OK"
  else
    echo "KO"
  fi
}

check_ui_text() {
  local host="$1"

  OUTPUT=$(sshpass -p "$SSH_PASS" ssh -tt \
    -o StrictHostKeyChecking=no \
    -o ConnectTimeout=10 \
    -o LogLevel=Error \
    "${SSH_USER}@${host}" \
    "list sys db ui.advisory.text" 2>/dev/null | tr -d '\r')

  if echo "$OUTPUT" | grep -q "Orchestrated Device"; then
    echo "OK"
  else
    echo "KO"
  fi
}

#######################################
# MAIN
#######################################
TOTAL=$(grep -Ev '^\s*#|^\s*$' "$DEVICES_FILE" | wc -l | awk '{print $1}')
COUNT=0

echo
echo "üîé V√©rification AS3 / Service Discovery / Orchestrated Device"
echo

while IFS= read -r LINE || [[ -n "$LINE" ]]; do
  HOST=$(echo "$LINE" | tr -d '\r' | awk '{$1=$1;print}')
  [[ -z "$HOST" || "$HOST" =~ ^# ]] && continue

  COUNT=$((COUNT+1))

  echo "======================================"
  echo "‚û°Ô∏è  [$COUNT/$TOTAL] BIG-IP : $HOST"
  echo "======================================"

  AS3_STATUS=$(check_rest "$HOST" "/mgmt/shared/appsvcs/info")
  SD_STATUS=$(check_rest "$HOST" "/mgmt/shared/service-discovery/task")
  UI_STATUS=$(check_ui_text "$HOST")

  echo "AS3                 : $AS3_STATUS"
  echo "Service Discovery   : $SD_STATUS"
  echo "Orchestrated Device : $UI_STATUS"
  echo

done < "$DEVICES_FILE"

echo "üèÅ V√©rification termin√©e"
