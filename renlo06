#!/usr/bin/env bash
set -euo pipefail

#######################################
# CONFIG
#######################################
DEVICES_FILE="devices.txt"
OUT_BASE="./checks"
TS="$(date +%Y%m%d-%H%M%S)"
RUN_DIR="${OUT_BASE}/${TS}"
ERR_LOG="${RUN_DIR}/errors.log"

# Patterns (grep)
VS_GREP='LTM::Virtual|Availability'
POOL_GREP='LTM::Pool|Availability'
NODE_GREP='LTM::Node|Availability'
ASM_GREP='asm policy'

#######################################
# PRECHECKS
#######################################
for bin in ssh sshpass date awk sed grep sort; do
  command -v "$bin" >/dev/null || { echo "âŒ $bin requis"; exit 1; }
done

[[ -f "$DEVICES_FILE" ]] || { echo "âŒ Fichier Ã©quipements introuvable : $DEVICES_FILE"; exit 1; }
mkdir -p "$RUN_DIR"
: > "$ERR_LOG"

#######################################
# INPUTS
#######################################
read -p "Utilisateur SSH (compte qui arrive en tmsh): " SSH_USER
read -s -p "Mot de passe SSH: " SSH_PASS
echo

#######################################
# SSH helper
# On arrive en tmsh => on force bash via "run util bash -c"
#######################################
ssh_exec() {
  local HOST="$1"
  local CMD="$2"

  # -n Ã©vite de consommer stdin (important pour while read)
  sshpass -p "$SSH_PASS" ssh -n \
    -o StrictHostKeyChecking=no \
    -o ConnectTimeout=15 \
    -o LogLevel=Error \
    "${SSH_USER}@${HOST}" \
    "run util bash -c \"$CMD\""
}

#######################################
# Partitions
#######################################
get_partitions() {
  local HOST="$1"
  # sort -u for safety, remove empty lines
  ssh_exec "$HOST" "tmsh -c 'list auth partition one-line' | awk '{print \$3}' | sed '/^$/d' | sort -u"
}

#######################################
# Host checks
#######################################
run_checks_for_host() {
  local HOST="$1"
  local HOST_DIR="${RUN_DIR}/${HOST}"
  mkdir -p "$HOST_DIR"

  local VS_OUT="${HOST_DIR}/virtual_servers.txt"
  local POOL_OUT="${HOST_DIR}/pools.txt"
  local NODE_OUT="${HOST_DIR}/nodes.txt"
  local ASM_OUT="${HOST_DIR}/asm_policies.txt"

  : > "$VS_OUT"
  : > "$POOL_OUT"
  : > "$NODE_OUT"
  : > "$ASM_OUT"

  echo "======================================"
  echo "âž¡ï¸  BIG-IP : $HOST"
  echo "======================================"

  ###################################
  # ASM (global, no cd)
  ###################################
  echo "ðŸ”Ž ASM policies"
  if ! ssh_exec "$HOST" "tmsh -c 'list asm policy recursive' | grep -i \"$ASM_GREP\"" \
      > "$ASM_OUT" 2>>"$ERR_LOG"; then
    echo "[$HOST] âŒ ASM policies failed" >>"$ERR_LOG"
  fi

  ###################################
  # Partitions
  ###################################
  echo "ðŸ”Ž Partitions"
  PARTS="$(get_partitions "$HOST" 2>>"$ERR_LOG" || true)"
  if [[ -z "${PARTS:-}" ]]; then
    echo "[$HOST] âš ï¸ Partitions non rÃ©cupÃ©rÃ©es, fallback /Common" >>"$ERR_LOG"
    PARTS="Common"
  fi

  ###################################
  # LTM objects per partition
  ###################################
  while IFS= read -r P || [[ -n "$P" ]]; do
    [[ -z "$P" ]] && continue

    # Header per partition for readability
    {
      echo "===== /$P ====="
    } >> "$VS_OUT"
    {
      echo "===== /$P ====="
    } >> "$POOL_OUT"
    {
      echo "===== /$P ====="
    } >> "$NODE_OUT"

    # VS
    echo "  ðŸ”Ž VS (/$(printf "%s" "$P"))"
    if ! ssh_exec "$HOST" \
      "tmsh -c \"cd /${P}; show ltm virtual recursive\" | grep -E \"$VS_GREP\" || true" \
      >> "$VS_OUT" 2>>"$ERR_LOG"; then
      echo "[$HOST] âŒ VS failed in /$P" >>"$ERR_LOG"
    fi
    echo >> "$VS_OUT"

    # Pools
    echo "  ðŸ”Ž Pools (/$(printf "%s" "$P"))"
    if ! ssh_exec "$HOST" \
      "tmsh -c \"cd /${P}; show ltm pool recursive members\" | grep -E \"$POOL_GREP\" || true" \
      >> "$POOL_OUT" 2>>"$ERR_LOG"; then
      echo "[$HOST] âŒ Pools failed in /$P" >>"$ERR_LOG"
    fi
    echo >> "$POOL_OUT"

    # Nodes
    echo "  ðŸ”Ž Nodes (/$(printf "%s" "$P"))"
    if ! ssh_exec "$HOST" \
      "tmsh -c \"cd /${P}; show ltm node recursive\" | grep -E \"$NODE_GREP\" || true" \
      >> "$NODE_OUT" 2>>"$ERR_LOG"; then
      echo "[$HOST] âŒ Nodes failed in /$P" >>"$ERR_LOG"
    fi
    echo >> "$NODE_OUT"

  done <<< "$PARTS"

  echo "âœ… Export terminÃ© pour $HOST"
  echo "   - $VS_OUT"
  echo "   - $POOL_OUT"
  echo "   - $NODE_OUT"
  echo "   - $ASM_OUT"
  echo
}

#######################################
# MAIN
#######################################
echo
echo "ðŸ“‹ F5 Check (tmsh login) â€“ Run: $TS"
echo "ðŸ“ RÃ©sultats : $RUN_DIR"
echo "ðŸ§¾ Erreurs   : $ERR_LOG"
echo

while IFS= read -r LINE || [[ -n "$LINE" ]]; do
  HOST="$(echo "$LINE" | tr -d '\r' | xargs)"
  [[ -z "$HOST" || "$HOST" =~ ^# ]] && continue
  run_checks_for_host "$HOST"
done < "$DEVICES_FILE"

echo "ðŸ TerminÃ©"
if [[ -s "$ERR_LOG" ]]; then
  echo "âš ï¸  Des erreurs ont Ã©tÃ© dÃ©tectÃ©es : $ERR_LOG"
else
  echo "âœ… Aucun Ã©chec dÃ©tectÃ©"
fi
