#!/usr/bin/env bash
set -euo pipefail

#######################################
# CONFIG
#######################################
DEVICES_FILE="devices.txt"
OUT_BASE="./checks"
TS="$(date +%Y%m%d-%H%M%S)"
RUN_DIR="${OUT_BASE}/${TS}"
ERR_LOG="${RUN_DIR}/errors.log"

#######################################
# PRECHECKS
#######################################
for bin in ssh sshpass date grep; do
  command -v "$bin" >/dev/null || { echo "‚ùå $bin requis"; exit 1; }
done

[[ -f "$DEVICES_FILE" ]] || { echo "‚ùå Fichier √©quipements introuvable : $DEVICES_FILE"; exit 1; }
mkdir -p "$RUN_DIR"

#######################################
# INPUTS
#######################################
read -p "Utilisateur SSH (ex: root/admin): " SSH_USER
read -s -p "Mot de passe SSH: " SSH_PASS
echo

#######################################
# SSH helper (ROBUST QUOTING)
#######################################
ssh_exec() {
  local HOST="$1"
  local CMD="$2"

  # -n : √©vite que ssh lise stdin (important dans une boucle while read)
  # bash -lc '<CMD>' : garde intact pipes/quotes du CMD
  sshpass -p "$SSH_PASS" ssh -n \
    -o StrictHostKeyChecking=no \
    -o ConnectTimeout=15 \
    -o LogLevel=Error \
    "${SSH_USER}@${HOST}" \
    "bash -lc '$CMD'"
}

#######################################
# Run checks for one host
#######################################
run_checks_for_host() {
  local HOST="$1"
  local HOST_DIR="${RUN_DIR}/${HOST}"
  mkdir -p "$HOST_DIR"

  echo "======================================"
  echo "‚û°Ô∏è  BIG-IP : $HOST"
  echo "======================================"

  # 1) ASM policies
  echo "üîé ASM policies"
  if ! ssh_exec "$HOST" 'tmsh -c "cd /; list asm policy recursive" | grep "asm policy"'; then
    echo "[$HOST] ‚ùå ASM policies failed" >>"$ERR_LOG"
  fi > "${HOST_DIR}/asm_policies.txt" 2>>"$ERR_LOG"

  # 2) Virtual Servers (typo fix: virtual)
  echo "üîé Virtual Servers"
  if ! ssh_exec "$HOST" 'tmsh -c "cd /; show ltm virtual recursive" | grep "LTM::Virtual\|Availability"'; then
    echo "[$HOST] ‚ùå Virtual Servers failed" >>"$ERR_LOG"
  fi > "${HOST_DIR}/virtual_servers.txt" 2>>"$ERR_LOG"

  # 3) Pools
  echo "üîé Pools"
  if ! ssh_exec "$HOST" 'tmsh -c "cd /; show ltm pool recursive members" | grep "LTM::Pool\|Availability"'; then
    echo "[$HOST] ‚ùå Pools failed" >>"$ERR_LOG"
  fi > "${HOST_DIR}/pools.txt" 2>>"$ERR_LOG"

  # 4) Nodes
  echo "üîé Nodes"
  if ! ssh_exec "$HOST" 'tmsh -c "cd /; show ltm node recursive" | grep "LTM::Node\|Availability"'; then
    echo "[$HOST] ‚ùå Nodes failed" >>"$ERR_LOG"
  fi > "${HOST_DIR}/nodes.txt" 2>>"$ERR_LOG"

  echo "‚úÖ Export termin√© pour $HOST"
  echo
}

#######################################
# MAIN
#######################################
echo
echo "üìã F5 Check (tmsh) ‚Äì Run: $TS"
echo "üìÅ Sortie : $RUN_DIR"
echo "üßæ Erreurs: $ERR_LOG"
echo

: > "$ERR_LOG"

while IFS= read -r LINE || [[ -n "$LINE" ]]; do
  HOST="$(echo "$LINE" | tr -d '\r' | xargs)"
  [[ -z "$HOST" || "$HOST" =~ ^# ]] && continue
  run_checks_for_host "$HOST"
done < "$DEVICES_FILE"

echo "üèÅ Termin√©"
echo "üìÅ R√©sultats : $RUN_DIR"
if [[ -s "$ERR_LOG" ]]; then
  echo "‚ö†Ô∏è  Des erreurs ont √©t√© d√©tect√©es : $ERR_LOG"
else
  echo "‚úÖ Aucun √©chec d√©tect√©"
fi
