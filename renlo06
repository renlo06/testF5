#!/usr/bin/env bash
set -euo pipefail

#######################################
# CONFIG
#######################################
DEVICES_FILE="devices.txt"
OUT_BASE="./checks"
TS="$(date +%Y%m%d-%H%M%S)"
RUN_DIR="${OUT_BASE}/${TS}"
ERR_LOG="${RUN_DIR}/errors.log"

#######################################
# PRECHECKS
#######################################
for bin in ssh sshpass date awk sed grep sort; do
  command -v "$bin" >/dev/null || { echo "âŒ $bin requis"; exit 1; }
done

[[ -f "$DEVICES_FILE" ]] || { echo "âŒ Fichier Ã©quipements introuvable : $DEVICES_FILE"; exit 1; }
mkdir -p "$RUN_DIR"
: > "$ERR_LOG"

#######################################
# INPUTS
#######################################
read -p "Utilisateur SSH (compte qui arrive en tmsh): " SSH_USER
read -s -p "Mot de passe SSH: " SSH_PASS
echo

#######################################
# SSH helper (tmsh-login safe)
# run util bash -c '...'
#######################################
ssh_exec() {
  local HOST="$1"
  local CMD="$2"

  # Escape single quotes for: run util bash -c '...'
  local ESCAPED
  ESCAPED="${CMD//\'/\'\\\'\'}"

  sshpass -p "$SSH_PASS" ssh -n \
    -o StrictHostKeyChecking=no \
    -o ConnectTimeout=15 \
    -o LogLevel=Error \
    "${SSH_USER}@${HOST}" \
    "run util bash -c '$ESCAPED'"
}

get_partitions() {
  local HOST="$1"
  ssh_exec "$HOST" "tmsh -c \"list auth partition one-line\"" \
    | awk '{print $3}' \
    | sed '/^$/d' \
    | sort -u
}

run_tmsh_in_partition() {
  local HOST="$1"
  local PART="$2"
  local TMSH_CMD="$3"
  ssh_exec "$HOST" "tmsh -c \"cd /${PART}; ${TMSH_CMD}\""
}

run_checks_for_host() {
  local HOST="$1"
  local HOST_DIR="${RUN_DIR}/${HOST}"
  mkdir -p "$HOST_DIR"

  local ASM_OUT="${HOST_DIR}/asm_policies.txt"
  local POOL_OUT="${HOST_DIR}/pools.txt"
  local NODE_OUT="${HOST_DIR}/nodes.txt"

  : > "$ASM_OUT"
  : > "$POOL_OUT"
  : > "$NODE_OUT"

  # ---- ASM (global) ----
  if ! ssh_exec "$HOST" "tmsh -c \"list asm policy recursive\"" > "${ASM_OUT}.raw" 2>>"$ERR_LOG"; then
    echo "[$HOST] âŒ ASM tmsh failed" >>"$ERR_LOG"
  else
    # Filtre, sinon fallback raw
    grep -Ei "asm policy" "${ASM_OUT}.raw" > "$ASM_OUT" || true
    if [[ ! -s "$ASM_OUT" ]]; then
      mv -f "${ASM_OUT}.raw" "$ASM_OUT"
    else
      rm -f "${ASM_OUT}.raw"
    fi
  fi

  # ---- Partitions ----
  local PARTS
  PARTS="$(get_partitions "$HOST" 2>>"$ERR_LOG" || true)"
  if [[ -z "${PARTS:-}" ]]; then
    echo "[$HOST] âš ï¸ Partitions non rÃ©cupÃ©rÃ©es, fallback /Common" >>"$ERR_LOG"
    PARTS="Common"
  fi

  # ---- Pools + Nodes (toutes partitions) ----
  while IFS= read -r P || [[ -n "$P" ]]; do
    [[ -z "$P" ]] && continue

    # Pools (pas d'affichage partition dans le shell, uniquement dans le fichier)
    {
      echo "===== /$P ====="
      if OUT=$(run_tmsh_in_partition "$HOST" "$P" "show ltm pool recursive members" 2>>"$ERR_LOG"); then
        F=$(printf "%s\n" "$OUT" | grep -Eai "ltm::pool|availability" || true)
        if [[ -n "$F" ]]; then
          printf "%s\n\n" "$F"
        else
          printf "%s\n\n" "$OUT"
        fi
      else
        echo "[$HOST] âŒ Pools failed in /$P" >>"$ERR_LOG"
        echo "(ERROR pools /$P)"
        echo
      fi
    } >> "$POOL_OUT"

    # Nodes
    {
      echo "===== /$P ====="
      if OUT=$(run_tmsh_in_partition "$HOST" "$P" "show ltm node recursive" 2>>"$ERR_LOG"); then
        F=$(printf "%s\n" "$OUT" | grep -Eai "ltm::node|availability" || true)
        if [[ -n "$F" ]]; then
          printf "%s\n\n" "$F"
        else
          printf "%s\n\n" "$OUT"
        fi
      else
        echo "[$HOST] âŒ Nodes failed in /$P" >>"$ERR_LOG"
        echo "(ERROR nodes /$P)"
        echo
      fi
    } >> "$NODE_OUT"

  done <<< "$PARTS"
}

#######################################
# MAIN LOOP (silencieux)
#######################################
echo
echo "ðŸ“‹ F5 Check (silencieux, tmsh-login) â€“ Run: $TS"
echo "ðŸ“ RÃ©sultats : $RUN_DIR"
echo "ðŸ§¾ Erreurs   : $ERR_LOG"
echo

while IFS= read -r LINE || [[ -n "$LINE" ]]; do
  HOST="$(echo "$LINE" | tr -d '\r' | xargs)"
  [[ -z "$HOST" || "$HOST" =~ ^# ]] && continue

  printf "âž¡ï¸  %-30s ... " "$HOST"
  if run_checks_for_host "$HOST"; then
    echo "âœ… OK"
  else
    echo "âŒ KO"
    echo "[$HOST] âŒ run_checks_for_host failed" >>"$ERR_LOG"
  fi
done < "$DEVICES_FILE"

echo
echo "ðŸ TerminÃ©"
if [[ -s "$ERR_LOG" ]]; then
  echo "âš ï¸  Des erreurs ont Ã©tÃ© dÃ©tectÃ©es : $ERR_LOG"
else
  echo "âœ… Aucun Ã©chec dÃ©tectÃ©"
fi
