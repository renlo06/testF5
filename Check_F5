#!/usr/bin/env bash
set -euo pipefail

#######################################
# CONFIG
#######################################
DEVICES_FILE="devices.txt"
BASE_OUTPUT_DIR="./audit"

RUN_TIMESTAMP=$(date +%Y%m%d_%H-%M-%S)
OUTPUT_DIR="${BASE_OUTPUT_DIR}/${RUN_TIMESTAMP}"

#######################################
# PRECHECKS
#######################################
for bin in ssh sshpass date grep; do
  command -v "$bin" >/dev/null || {
    echo "‚ùå $bin requis"
    exit 1
  }
done

[[ -f "$DEVICES_FILE" ]] || {
  echo "‚ùå Fichier √©quipements introuvable : $DEVICES_FILE"
  exit 1
}

mkdir -p "$OUTPUT_DIR"

#######################################
# INPUTS
#######################################
read -p "Utilisateur SSH (admin/root): " SSH_USER
read -s -p "Mot de passe SSH: " SSH_PASS
echo

LOG_FILE="${OUTPUT_DIR}/audit.log"

#######################################
# FUNCTIONS
#######################################
run_tmsh_cmd() {
  local HOST="$1"
  local CMD="$2"
  local OUT_FILE="$3"

  sshpass -p "$SSH_PASS" ssh \
    -o StrictHostKeyChecking=no \
    -o ConnectTimeout=15 \
    -o LogLevel=Error \
    "$SSH_USER@$HOST" \
    "bash -c '$CMD'" \
    > "$OUT_FILE" 2>>"$LOG_FILE"
}

#######################################
# COMMAND DEFINITIONS
#######################################
declare -A COMMANDS

COMMANDS[VS]='tmsh -c "cd /; show ltm virtual recursive" | grep "LTM::Virtual\|Availability"'
COMMANDS[POOL]='tmsh -c "cd /; show ltm pool recursive members" | grep "LTM::Pool\|Availability"'
COMMANDS[NODE]='tmsh -c "cd /; show ltm node recursive" | grep "LTM::Node\|Availability"'
COMMANDS[ASM_POLICY]='tmsh -c "cd /; list asm policy recursive" | grep "asm policy"'

#######################################
# MAIN
#######################################
echo "üìä Audit F5 d√©marr√©"
echo "Run timestamp : $RUN_TIMESTAMP"
echo "R√©sultats     : $OUTPUT_DIR"
echo

while IFS= read -r LINE || [[ -n "$LINE" ]]; do
  HOST=$(echo "$LINE" | tr -d '\r' | xargs)
  [[ -z "$HOST" || "$HOST" =~ ^# ]] && continue

  FILE_TIMESTAMP=$(date +%Y%m%d_%H%M%S)

  echo "======================================"
  echo "‚û°Ô∏è  BIG-IP : $HOST"
  echo "======================================"

  HOST_DIR="${OUTPUT_DIR}/${HOST}"
  LTM_DIR="${HOST_DIR}/ltm"
  ASM_DIR="${HOST_DIR}/asm"

  mkdir -p "$LTM_DIR" "$ASM_DIR"

  # VS
  echo "üîç VS"
  run_tmsh_cmd \
    "$HOST" \
    "${COMMANDS[VS]}" \
    "${LTM_DIR}/vs_${FILE_TIMESTAMP}.txt"

  # POOLS
  echo "üîç Pools"
  run_tmsh_cmd \
    "$HOST" \
    "${COMMANDS[POOL]}" \
    "${LTM_DIR}/pools_${FILE_TIMESTAMP}.txt"

  # NODES
  echo "üîç Nodes"
  run_tmsh_cmd \
    "$HOST" \
    "${COMMANDS[NODE]}" \
    "${LTM_DIR}/nodes_${FILE_TIMESTAMP}.txt"

  # ASM
  echo "üîç ASM Policies"
  run_tmsh_cmd \
    "$HOST" \
    "${COMMANDS[ASM_POLICY]}" \
    "${ASM_DIR}/asm_policies_${FILE_TIMESTAMP}.txt"

  echo "‚úÖ Audit termin√© pour $HOST"
  echo

done < "$DEVICES_FILE"

echo "======================================"
echo "üéØ Audit F5 termin√©"
echo "Logs : $LOG_FILE"
echo "======================================"
