#!/usr/bin/env bash
set -euo pipefail

for bin in ssh sshpass awk sed sort; do
  command -v "$bin" >/dev/null || { echo "❌ $bin requis"; exit 1; }
done

read -rp "Nom/IP de l'équipement BIG-IP: " HOST
read -rp "Utilisateur SSH (compte qui arrive en tmsh): " SSH_USER
read -s -rp "Mot de passe SSH: " SSH_PASS
echo

sshpass -p "$SSH_PASS" ssh -T \
  -o StrictHostKeyChecking=no \
  -o ConnectTimeout=15 \
  -o LogLevel=Error \
  "${SSH_USER}@${HOST}" "run util bash -s" <<'REMOTE_BASH'
set -euo pipefail

# Partitions visibles
PARTS="$(
  tmsh -c "list auth partition one-line" \
  | awk '$1=="auth" && $2=="partition" {print $3}' \
  | sed '/^$/d' \
  | sort -u
)"

if [[ -z "${PARTS:-}" ]]; then
  echo "❌ Aucune partition visible (droits insuffisants ?) ou sortie vide."
  exit 1
fi

get_vs_list() {
  local P="$1"
  tmsh -c "cd /${P}; list ltm virtual recursive one-line" 2>/dev/null \
  | awk '$1=="ltm" && $2=="virtual" {print $3}'
}

get_vs_availability() {
  local P="$1"
  local VS="$2"

  # On extrait la 1ère occurrence de "Availability"
  # Format souvent: "Availability : available"
  local avail
  avail="$(
    tmsh -c "cd /${P}; show ltm virtual ${VS}" 2>/dev/null \
    | awk -F':' '
        $1 ~ /Availability/ {
          gsub(/^[ \t]+/, "", $2);
          print $2;
          exit
        }'
  )"

  if [[ -z "${avail:-}" ]]; then
    echo "UNKNOWN"
  else
    echo "$avail"
  fi
}

while IFS= read -r P || [[ -n "$P" ]]; do
  [[ -z "$P" ]] && continue

  echo "===== /$P ====="

  VS_LIST="$(get_vs_list "$P" || true)"
  if [[ -z "${VS_LIST:-}" ]]; then
    echo "(0 VS visibles dans /$P)"
    echo
    continue
  fi

  # Affichage VS + Availability
  while IFS= read -r VS || [[ -n "$VS" ]]; do
    [[ -z "$VS" ]] && continue
    AVAIL="$(get_vs_availability "$P" "$VS")"
    printf "%s ; %s\n" "$VS" "$AVAIL"
  done <<< "$VS_LIST"

  echo
done <<< "$PARTS"
REMOTE_BASH
