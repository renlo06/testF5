#!/usr/bin/env bash
set -euo pipefail

#######################################
# CONFIG
#######################################
DEVICES_FILE="devices.txt"
OUT_BASE="./inventory"
TS=$(date +%Y%m%d-%H%M%S)
TOP=10000

#######################################
# PRECHECKS
#######################################
for bin in curl jq date; do
  command -v "$bin" >/dev/null || { echo "‚ùå $bin requis"; exit 1; }
done

[[ -f "$DEVICES_FILE" ]] || {
  echo "‚ùå Fichier √©quipements introuvable : $DEVICES_FILE"
  exit 1
}
mkdir -p "$OUT_BASE"

#######################################
# INPUTS
#######################################
read -p "Utilisateur API (ex: admin): " API_USER
read -s -p "Mot de passe API: " API_PASS
echo

AUTH=(-u "${API_USER}:${API_PASS}" -k -sS)

#######################################
# JQ HELPERS
#######################################
stats_to_avail_map_jq='
  def key_to_fullpath:
    ( . | capture("~(?<p>[^~]+)~(?<n>[^/]+)")? )
    | if . == null then null else ("/" + .p + "/" + .n) end;

  def pick_avail($e):
    (
      $e.nestedStats.entries.availabilityState.description? //
      $e.nestedStats.entries.status_availabilityState.description? //
      $e.nestedStats.entries.status.description? //
      $e.nestedStats.entries.availability.description? //
      empty
    );

  reduce (.entries // {} | to_entries[]) as $it ({}; 
    ($it.key | key_to_fullpath) as $fp
    | if $fp == null then . else . + { ($fp): (pick_avail($it.value) // "UNKNOWN") } end
  )
'

vs_csv_jq='
  (["fullPath","enabled","disabled","destination","ipProtocol","availability"] | @csv),
  (.items[]? | [
    .fullPath,
    (.enabled // ""),
    (.disabled // ""),
    (.destination // ""),
    (.ipProtocol // ""),
    ($avail[.fullPath] // "UNKNOWN")
  ] | @csv)
'

pools_csv_jq='
  (["fullPath","members","loadBalancingMode","availability"] | @csv),
  (.items[]? | [
    .fullPath,
    (.members // "" | tostring),
    (.loadBalancingMode // ""),
    ($avail[.fullPath] // "UNKNOWN")
  ] | @csv)
'

nodes_csv_jq='
  (["fullPath","address","availability"] | @csv),
  (.items[]? | [
    .fullPath,
    (.address // ""),
    ($avail[.fullPath] // "UNKNOWN")
  ] | @csv)
'

asm_csv_jq='
  (["name","id","fullPath"] | @csv),
  (.items[]? | [
    (.name // ""),
    (.id // ""),
    (.fullPath // "")
  ] | @csv)
'

#######################################
# MAIN
#######################################
echo
echo "üìã Inventaire BIG-IP (REST) ‚Äî CSV uniquement"
echo "üìÖ Horodatage : $TS"
echo

while IFS= read -r LINE || [[ -n "$LINE" ]]; do
  HOST=$(echo "$LINE" | tr -d '\r' | xargs)
  [[ -z "$HOST" || "$HOST" =~ ^# ]] && continue

  HOST_DIR="${OUT_BASE}/${HOST}/${TS}"
  mkdir -p "$HOST_DIR"

  echo "======================================"
  echo "‚û°Ô∏è  BIG-IP : $HOST"
  echo "======================================"

  ###################################
  # VIRTUAL SERVERS
  ###################################
  echo "üîé VS"
  VS_CFG=$(curl "${AUTH[@]}" \
    "https://${HOST}/mgmt/tm/ltm/virtual?\$select=fullPath,enabled,disabled,destination,ipProtocol&\$top=${TOP}")

  VS_STATS=$(curl "${AUTH[@]}" \
    "https://${HOST}/mgmt/tm/ltm/virtual/stats?\$top=${TOP}" || echo '{}')

  AVAIL=$(jq -c "$stats_to_avail_map_jq" <<<"$VS_STATS" 2>/dev/null || echo '{}')

  jq --argjson avail "$AVAIL" -r "$vs_csv_jq" <<<"$VS_CFG" \
    > "${HOST_DIR}/vs_inventory.csv"

  echo "‚úÖ VS export√©s"

  ###################################
  # POOLS
  ###################################
  echo "üîé Pools"
  POOL_CFG=$(curl "${AUTH[@]}" \
    "https://${HOST}/mgmt/tm/ltm/pool?\$select=fullPath,members,loadBalancingMode&\$top=${TOP}")

  POOL_STATS=$(curl "${AUTH[@]}" \
    "https://${HOST}/mgmt/tm/ltm/pool/stats?\$top=${TOP}" || echo '{}')

  AVAIL=$(jq -c "$stats_to_avail_map_jq" <<<"$POOL_STATS" 2>/dev/null || echo '{}')

  jq --argjson avail "$AVAIL" -r "$pools_csv_jq" <<<"$POOL_CFG" \
    > "${HOST_DIR}/pools_inventory.csv"

  echo "‚úÖ Pools export√©s"

  ###################################
  # NODES
  ###################################
  echo "üîé Nodes"
  NODE_CFG=$(curl "${AUTH[@]}" \
    "https://${HOST}/mgmt/tm/ltm/node?\$select=fullPath,address&\$top=${TOP}")

  NODE_STATS=$(curl "${AUTH[@]}" \
    "https://${HOST}/mgmt/tm/ltm/node/stats?\$top=${TOP}" || echo '{}')

  AVAIL=$(jq -c "$stats_to_avail_map_jq" <<<"$NODE_STATS" 2>/dev/null || echo '{}')

  jq --argjson avail "$AVAIL" -r "$nodes_csv_jq" <<<"$NODE_CFG" \
    > "${HOST_DIR}/nodes_inventory.csv"

  echo "‚úÖ Nodes export√©s"

  ###################################
  # ASM POLICIES
  ###################################
  echo "üîé ASM Policies"
  ASM_JSON=$(curl "${AUTH[@]}" \
    "https://${HOST}/mgmt/tm/asm/policies?\$select=name,id,fullPath&\$top=${TOP}" || echo '{}')

  jq -r "$asm_csv_jq" <<<"$ASM_JSON" \
    > "${HOST_DIR}/asm_policies.csv"

  echo "‚úÖ ASM policies export√©es"
  echo
done < "$DEVICES_FILE"

echo "üèÅ Inventaire termin√© (CSV uniquement)"
