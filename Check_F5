#!/usr/bin/env bash
set -euo pipefail

#######################################
# CONFIG
#######################################
DEVICES_FILE="devices.txt"
OUT_BASE="./inventory"
TS=$(date +%Y%m%d-%H%M%S)
TOP=10000

#######################################
# PRECHECKS
#######################################
for bin in curl jq date; do
  command -v "$bin" >/dev/null || { echo "‚ùå $bin requis"; exit 1; }
done

[[ -f "$DEVICES_FILE" ]] || { echo "‚ùå Fichier √©quipements introuvable : $DEVICES_FILE"; exit 1; }
mkdir -p "$OUT_BASE"

#######################################
# INPUTS
#######################################
read -p "Utilisateur API (ex: admin): " API_USER
read -s -p "Mot de passe API: " API_PASS
echo

AUTH=(-u "${API_USER}:${API_PASS}" -k -sS)

#######################################
# GLOBAL SUMMARY OUTPUTS
#######################################
SUMMARY_CSV="${OUT_BASE}/summary_${TS}.csv"
SUMMARY_TXT="${OUT_BASE}/summary_${TS}.txt"

echo 'host,vs_total,vs_up,vs_down,vs_unknown,pools_total,pools_up,pools_down,pools_unknown,nodes_total,nodes_up,nodes_down,nodes_unknown,asm_policies_total' > "$SUMMARY_CSV"
{
  echo "Run: $TS"
  echo
} > "$SUMMARY_TXT"

#######################################
# JQ HELPERS
#######################################
stats_to_avail_map_jq='
  def key_to_fullpath:
    ( . | capture("~(?<p>[^~]+)~(?<n>[^/]+)")? )
    | if . == null then null else ("/" + .p + "/" + .n) end;

  def pick_avail($e):
    (
      $e.nestedStats.entries.availabilityState.description? //
      $e.nestedStats.entries.status_availabilityState.description? //
      $e.nestedStats.entries.status.description? //
      $e.nestedStats.entries.availability.description? //
      empty
    );

  reduce (.entries // {} | to_entries[]) as $it ({}; 
    ($it.key | key_to_fullpath) as $fp
    | if $fp == null then . else . + { ($fp): (pick_avail($it.value) // "UNKNOWN") } end
  )
'

count_status_obj_jq='
  def is_up($s): ($s | ascii_upcase | test("AVAILABLE|UP"));
  def st($s):
    if $s == null or $s == "UNKNOWN" then "unknown"
    elif is_up($s) then "up"
    else "down" end;

  .items // [] as $items
  | ($items | length) as $total
  | ($items | map(st($avail[.fullPath])) ) as $st
  | {
      total: $total,
      up: ($st | map(select(.=="up")) | length),
      down: ($st | map(select(.=="down")) | length),
      unknown: ($st | map(select(.=="unknown")) | length)
    }
'

vs_csv_jq='
  (["fullPath","enabled","disabled","destination","ipProtocol","availability"] | @csv),
  (.items[]? | [
    .fullPath,
    (.enabled // ""),
    (.disabled // ""),
    (.destination // ""),
    (.ipProtocol // ""),
    ($avail[.fullPath] // "UNKNOWN")
  ] | @csv)
'

pools_csv_jq='
  (["fullPath","members","loadBalancingMode","availability"] | @csv),
  (.items[]? | [
    .fullPath,
    (.members // "" | tostring),
    (.loadBalancingMode // ""),
    ($avail[.fullPath] // "UNKNOWN")
  ] | @csv)
'

nodes_csv_jq='
  (["fullPath","address","availability"] | @csv),
  (.items[]? | [
    .fullPath,
    (.address // ""),
    ($avail[.fullPath] // "UNKNOWN")
  ] | @csv)
'

asm_csv_jq='
  (["name","id","fullPath"] | @csv),
  (.items[]? | [
    (.name // ""),
    (.id // ""),
    (.fullPath // "")
  ] | @csv)
'

#######################################
# MAIN
#######################################
echo
echo "üìã Inventaire BIG-IP (REST) ‚Äî CSV + synth√®se CSV/TXT"
echo "üìÖ Horodatage : $TS"
echo "üìÑ Synth√®se CSV : $SUMMARY_CSV"
echo "üìù Synth√®se TXT : $SUMMARY_TXT"
echo

while IFS= read -r LINE || [[ -n "$LINE" ]]; do
  HOST=$(echo "$LINE" | tr -d '\r' | xargs)
  [[ -z "$HOST" || "$HOST" =~ ^# ]] && continue

  HOST_DIR="${OUT_BASE}/${HOST}/${TS}"
  mkdir -p "$HOST_DIR"

  echo "======================================"
  echo "‚û°Ô∏è  BIG-IP : $HOST"
  echo "======================================"

  ###################################
  # VS
  ###################################
  echo "üîé VS"
  VS_CFG=$(curl "${AUTH[@]}" "https://${HOST}/mgmt/tm/ltm/virtual?\$select=fullPath,enabled,disabled,destination,ipProtocol&\$top=${TOP}")
  VS_STATS=$(curl "${AUTH[@]}" "https://${HOST}/mgmt/tm/ltm/virtual/stats?\$top=${TOP}" || echo '{}')
  VS_AVAIL=$(jq -c "$stats_to_avail_map_jq" <<<"$VS_STATS" 2>/dev/null || echo '{}')
  jq --argjson avail "$VS_AVAIL" -r "$vs_csv_jq" <<<"$VS_CFG" > "${HOST_DIR}/vs_inventory.csv"

  VS_COUNT_OBJ=$(jq --argjson avail "$VS_AVAIL" -c "$count_status_obj_jq" <<<"$VS_CFG" 2>/dev/null || echo '{"total":0,"up":0,"down":0,"unknown":0}')
  VS_TOTAL=$(jq -r '.total'   <<<"$VS_COUNT_OBJ")
  VS_UP=$(jq -r '.up'         <<<"$VS_COUNT_OBJ")
  VS_DOWN=$(jq -r '.down'     <<<"$VS_COUNT_OBJ")
  VS_UNK=$(jq -r '.unknown'   <<<"$VS_COUNT_OBJ")

  ###################################
  # POOLS
  ###################################
  echo "üîé Pools"
  POOL_CFG=$(curl "${AUTH[@]}" "https://${HOST}/mgmt/tm/ltm/pool?\$select=fullPath,members,loadBalancingMode&\$top=${TOP}")
  POOL_STATS=$(curl "${AUTH[@]}" "https://${HOST}/mgmt/tm/ltm/pool/stats?\$top=${TOP}" || echo '{}')
  POOL_AVAIL=$(jq -c "$stats_to_avail_map_jq" <<<"$POOL_STATS" 2>/dev/null || echo '{}')
  jq --argjson avail "$POOL_AVAIL" -r "$pools_csv_jq" <<<"$POOL_CFG" > "${HOST_DIR}/pools_inventory.csv"

  POOL_COUNT_OBJ=$(jq --argjson avail "$POOL_AVAIL" -c "$count_status_obj_jq" <<<"$POOL_CFG" 2>/dev/null || echo '{"total":0,"up":0,"down":0,"unknown":0}')
  POOL_TOTAL=$(jq -r '.total'   <<<"$POOL_COUNT_OBJ")
  POOL_UP=$(jq -r '.up'         <<<"$POOL_COUNT_OBJ")
  POOL_DOWN=$(jq -r '.down'     <<<"$POOL_COUNT_OBJ")
  POOL_UNK=$(jq -r '.unknown'   <<<"$POOL_COUNT_OBJ")

  ###################################
  # NODES
  ###################################
  echo "üîé Nodes"
  NODE_CFG=$(curl "${AUTH[@]}" "https://${HOST}/mgmt/tm/ltm/node?\$select=fullPath,address&\$top=${TOP}")
  NODE_STATS=$(curl "${AUTH[@]}" "https://${HOST}/mgmt/tm/ltm/node/stats?\$top=${TOP}" || echo '{}')
  NODE_AVAIL=$(jq -c "$stats_to_avail_map_jq" <<<"$NODE_STATS" 2>/dev/null || echo '{}')
  jq --argjson avail "$NODE_AVAIL" -r "$nodes_csv_jq" <<<"$NODE_CFG" > "${HOST_DIR}/nodes_inventory.csv"

  NODE_COUNT_OBJ=$(jq --argjson avail "$NODE_AVAIL" -c "$count_status_obj_jq" <<<"$NODE_CFG" 2>/dev/null || echo '{"total":0,"up":0,"down":0,"unknown":0}')
  NODE_TOTAL=$(jq -r '.total'   <<<"$NODE_COUNT_OBJ")
  NODE_UP=$(jq -r '.up'         <<<"$NODE_COUNT_OBJ")
  NODE_DOWN=$(jq -r '.down'     <<<"$NODE_COUNT_OBJ")
  NODE_UNK=$(jq -r '.unknown'   <<<"$NODE_COUNT_OBJ")

  ###################################
  # ASM POLICIES
  ###################################
  echo "üîé ASM Policies"
  ASM_JSON=$(curl "${AUTH[@]}" "https://${HOST}/mgmt/tm/asm/policies?\$select=name,id,fullPath&\$top=${TOP}" || echo '{}')
  jq -r "$asm_csv_jq" <<<"$ASM_JSON" > "${HOST_DIR}/asm_policies.csv"
  ASM_TOTAL=$(jq -r '(.items // []) | length' <<<"$ASM_JSON")

  ###################################
  # SUMMARY CSV
  ###################################
  echo "${HOST},${VS_TOTAL},${VS_UP},${VS_DOWN},${VS_UNK},${POOL_TOTAL},${POOL_UP},${POOL_DOWN},${POOL_UNK},${NODE_TOTAL},${NODE_UP},${NODE_DOWN},${NODE_UNK},${ASM_TOTAL}" \
    >> "$SUMMARY_CSV"

  ###################################
  # SUMMARY TXT (UP/DOWN/UNKNOWN)
  ###################################
  {
    echo "Host: $HOST"
    echo "  VS    : total=${VS_TOTAL}  up=${VS_UP}  down=${VS_DOWN}  unknown=${VS_UNK}"
    echo "  Pools : total=${POOL_TOTAL}  up=${POOL_UP}  down=${POOL_DOWN}  unknown=${POOL_UNK}"
    echo "  Nodes : total=${NODE_TOTAL}  up=${NODE_UP}  down=${NODE_DOWN}  unknown=${NODE_UNK}"
    echo "  ASM Policies: total=${ASM_TOTAL}"
    echo
  } >> "$SUMMARY_TXT"

  echo "‚úÖ Export termin√© pour $HOST"
  echo
done < "$DEVICES_FILE"

echo "üèÅ Termin√©"
echo "üìÑ Synth√®se CSV : $SUMMARY_CSV"
echo "üìù Synth√®se TXT : $SUMMARY_TXT"
