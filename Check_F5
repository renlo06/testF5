#!/usr/bin/env bash
set -euo pipefail

#######################################
# PRECHECKS
#######################################
for bin in ssh sshpass awk sed sort; do
  command -v "$bin" >/dev/null || { echo "❌ $bin requis"; exit 1; }
done

#######################################
# INPUTS
#######################################
read -rp "Nom/IP de l'équipement BIG-IP: " HOST
read -rp "Utilisateur SSH (compte qui arrive en tmsh): " SSH_USER
read -s -rp "Mot de passe SSH: " SSH_PASS
echo

#######################################
# SSH helper (tmsh-login SAFE)
# Exécute toujours via: run util bash -c '...'
# Et protège les quotes simples dans la commande.
#######################################
ssh_exec() {
  local cmd="$1"
  local escaped
  escaped="${cmd//\'/\'\\\'\'}"   # '  ->  '\''
  sshpass -p "$SSH_PASS" ssh -n \
    -o StrictHostKeyChecking=no \
    -o ConnectTimeout=15 \
    -o LogLevel=Error \
    "${SSH_USER}@${HOST}" \
    "run util bash -c '$escaped'"
}

#######################################
# MAIN
#######################################
# 1) Partitions visibles (filtre strict)
PARTS="$(
  ssh_exec "tmsh -c \"list auth partition one-line\" | awk '\$1==\"auth\" && \$2==\"partition\" {print \$3}' | sed '/^$/d' | sort -u" \
  || true
)"

if [[ -z "${PARTS:-}" ]]; then
  echo "❌ Impossible de récupérer les partitions (droits insuffisants ?) ou sortie vide."
  exit 1
fi

# 2) Liste des VS par partition
while IFS= read -r P || [[ -n "$P" ]]; do
  [[ -z "$P" ]] && continue

  echo "===== /$P ====="
  ssh_exec "tmsh -c \"cd /${P}; list ltm virtual one-line\" | awk '/^ltm virtual \\/{print \$3}'" || true
  echo
done <<< "$PARTS"
