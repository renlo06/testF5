#!/usr/bin/env bash
set -euo pipefail

DEVICES_FILE="devices.txt"
OUTPUT_DIR="./checks"

COMMAND_TYPE="VS"
FILENAME="vs"
TMSH_COMMAND='tmsh -c "show ltm virtual one-line"'
GREP_FILTER='LTM::Virtual|Availability'

# V√©rification des outils
for bin in ssh sshpass date grep; do
  command -v "$bin" >/dev/null || { echo "‚ùå $bin requis"; exit 1; }
done

[[ -f "$DEVICES_FILE" ]] || { echo "‚ùå Fichier √©quipements introuvable : $DEVICES_FILE"; exit 1; }
mkdir -p "$OUTPUT_DIR"

read -p "Utilisateur SSH (root recommand√©): " SSH_USER
read -s -p "Mot de passe SSH: " SSH_PASS
echo

TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
echo "üîç V√©rification Virtual Servers (VS) - $TIMESTAMP"

while IFS= read -r LINE || [[ -n "$LINE" ]]; do
  HOST=$(echo "$LINE" | tr -d '\r' | xargs)
  [[ -z "$HOST" || "$HOST" =~ ^# ]] && continue

  HOST_DIR="${OUTPUT_DIR}/${HOST}/${TIMESTAMP}"
  mkdir -p "$HOST_DIR"
  OUTPUT_FILE="${HOST_DIR}/${FILENAME}_${TIMESTAMP}.txt"
  ERROR_LOG="${HOST_DIR}/errors.log"
  : > "$ERROR_LOG"

  echo "======================================"
  echo "‚û°Ô∏è  BIG-IP : $HOST"
  echo "======================================"

  # ‚ö° SSH avec tmsh correctement √©chapp√©
  sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=15 \
    "$SSH_USER@$HOST" "$TMSH_COMMAND" 2>>"$ERROR_LOG" \
    | grep -E "$GREP_FILTER" > "$OUTPUT_FILE" || true

  if [[ -s "$OUTPUT_FILE" ]]; then
    echo "‚úÖ $(basename "$OUTPUT_FILE") g√©n√©r√©"
  else
    echo "‚ö†Ô∏è  Fichier vide : $(basename "$OUTPUT_FILE")"
    echo "[$HOST] Fichier vide" >>"$ERROR_LOG"
  fi

  [[ -s "$ERROR_LOG" ]] && echo "‚ö†Ô∏è  Des erreurs d√©tect√©es (voir errors.log)" || rm -f "$ERROR_LOG"

  echo
done < "$DEVICES_FILE"

echo "======================================"
echo "üèÅ V√©rification termin√©e"
echo "üìÇ R√©sultats : $OUTPUT_DIR"
echo "======================================"
