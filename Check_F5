#!/usr/bin/env bash
set -euo pipefail

#######################################
# CONFIG
#######################################
DEVICES_FILE="devices.txt"
BASE_OUTPUT_DIR="./checks"

#######################################
# PRECHECKS
#######################################
for bin in ssh sshpass date; do
  command -v "$bin" >/dev/null || {
    echo "‚ùå $bin requis"
    exit 1
  }
done

[[ -f "$DEVICES_FILE" ]] || {
  echo "‚ùå Fichier √©quipements introuvable : $DEVICES_FILE"
  exit 1
}

#######################################
# INPUTS
#######################################
read -p "Utilisateur SSH (root recommand√©): " SSH_USER
read -s -p "Mot de passe SSH: " SSH_PASS
echo

#######################################
# COMMAND DEFINITIONS
#######################################
declare -A COMMANDS
declare -A FILENAMES

COMMANDS[VS]='tmsh -c "cd /Common; show ltm virtual recursive"'
FILENAMES[VS]='vs'

COMMANDS[POOL]='tmsh -c "cd /Common; show ltm pool recursive members"'
FILENAMES[POOL]='pools'

COMMANDS[NODE]='tmsh -c "cd /Common; show ltm node recursive"'
FILENAMES[NODE]='nodes'

COMMANDS[ASM_POLICY]='tmsh -c "cd /Common; list asm policy recursive"'
FILENAMES[ASM_POLICY]='asm_policies'

#######################################
# MAIN LOOP
#######################################
TIMESTAMP=$(date +"%Y%m%d-%H%M%S")

echo
echo "üîç V√©rification BIG-IP"
echo "Horodatage : $TIMESTAMP"
echo

while IFS= read -r LINE || [[ -n "$LINE" ]]; do
  HOST=$(echo "$LINE" | tr -d '\r' | xargs)
  [[ -z "$HOST" || "$HOST" =~ ^# ]] && continue

  HOST_DIR="${BASE_OUTPUT_DIR}/${HOST}/${TIMESTAMP}"
  mkdir -p "$HOST_DIR"

  ERROR_LOG="${HOST_DIR}/errors.log"
  : > "$ERROR_LOG"

  echo "======================================"
  echo "‚û°Ô∏è  BIG-IP : $HOST"
  echo "üìÇ Dossier : $HOST_DIR"
  echo "======================================"

  for TYPE in "${!COMMANDS[@]}"; do
    OUTPUT_FILE="${HOST_DIR}/${FILENAMES[$TYPE]}_${TIMESTAMP}.txt"

    echo "üîé V√©rification $TYPE"

    sshpass -p "$SSH_PASS" ssh \
      -o StrictHostKeyChecking=no \
      -o LogLevel=Error \
      "$SSH_USER@$HOST" \
      "${COMMANDS[$TYPE]}" \
      > "$OUTPUT_FILE" 2>>"$ERROR_LOG" || true

    if [[ -s "$OUTPUT_FILE" ]]; then
      echo "‚úÖ R√©sultat √©crit : $(basename "$OUTPUT_FILE")"
    else
      echo "‚ö†Ô∏è  Fichier vide : $(basename "$OUTPUT_FILE")"
    fi
  done

  if [[ -s "$ERROR_LOG" ]]; then
    echo "‚ö†Ô∏è  Des erreurs ont √©t√© d√©tect√©es (voir errors.log)"
  else
    rm -f "$ERROR_LOG"
    echo "‚úÖ Aucune erreur d√©tect√©e"
  fi

  echo
done < "$DEVICES_FILE"

echo "üéØ V√©rifications termin√©es pour tous les √©quipements"
