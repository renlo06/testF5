#!/usr/bin/env bash
set -euo pipefail

#######################################
# CONFIG
#######################################
DEVICES_FILE="devices.txt"
OUTPUT_DIR="./checks"
ERROR_LOG="./checks/errors.log"

#######################################
# PRECHECKS
#######################################
for bin in ssh sshpass date; do
  command -v "$bin" >/dev/null || {
    echo "âŒ $bin requis"
    exit 1
  }
done

[[ -f "$DEVICES_FILE" ]] || {
  echo "âŒ Fichier Ã©quipements introuvable : $DEVICES_FILE"
  exit 1
}

mkdir -p "$OUTPUT_DIR"
: > "$ERROR_LOG"

#######################################
# INPUTS
#######################################
read -p "Utilisateur SSH (root recommandÃ©): " SSH_USER
read -s -p "Mot de passe SSH: " SSH_PASS
echo

#######################################
# COMMANDES TMSH (CORRIGÃ‰ES)
#######################################
declare -A COMMANDS
declare -A FILENAMES

COMMANDS[VS]='tmsh -c "show ltm virtual recursive"'
FILENAMES[VS]="vs"

COMMANDS[POOL]='tmsh -c "show ltm pool recursive members"'
FILENAMES[POOL]="pools"

COMMANDS[NODE]='tmsh -c "show ltm node recursive"'
FILENAMES[NODE]="nodes"

COMMANDS[ASM_POLICY]='tmsh -c "list asm policy recursive"'
FILENAMES[ASM_POLICY]="asm_policies"

#######################################
# MAIN LOOP
#######################################
DATE=$(date +"%Y%m%d-%H%M%S")

echo
echo "ðŸ” Collecte Ã©tat BIG-IP"
echo "ðŸ“… Date : $DATE"
echo

while IFS= read -r LINE || [[ -n "$LINE" ]]; do
  HOST=$(echo "$LINE" | tr -d '\r' | xargs)
  [[ -z "$HOST" || "$HOST" =~ ^# ]] && continue

  echo "======================================"
  echo "âž¡ï¸  BIG-IP : $HOST"
  echo "======================================"

  HOST_DIR="${OUTPUT_DIR}/${HOST}/${DATE}"
  mkdir -p "$HOST_DIR"

  for TYPE in "${!COMMANDS[@]}"; do
    FILE="${HOST_DIR}/${FILENAMES[$TYPE]}_${DATE}.txt"

    echo "ðŸ”Ž Collecte $TYPE"

    if sshpass -p "$SSH_PASS" ssh \
        -o StrictHostKeyChecking=no \
        -o ConnectTimeout=15 \
        -o LogLevel=Error \
        "$SSH_USER@$HOST" \
        "bash -lc '${COMMANDS[$TYPE]}'" \
        > "$FILE" 2>>"$ERROR_LOG"; then

      if [[ -s "$FILE" ]]; then
        echo "âœ… $TYPE OK â†’ $(basename "$FILE")"
      else
        echo "âš ï¸  $TYPE vide"
        echo "[$HOST][$TYPE] Fichier vide" >>"$ERROR_LOG"
      fi
    else
      echo "âŒ Erreur $TYPE"
      echo "[$HOST][$TYPE] Commande Ã©chouÃ©e" >>"$ERROR_LOG"
    fi

  done

  echo
done < "$DEVICES_FILE"

#######################################
# SUMMARY
#######################################
echo "======================================"
echo "ðŸ Collecte terminÃ©e"
echo "ðŸ“‚ RÃ©sultats : $OUTPUT_DIR"
echo "ðŸ“„ Erreurs   : $ERROR_LOG"
echo "======================================"
