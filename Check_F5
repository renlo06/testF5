#!/usr/bin/env bash
set -euo pipefail

for bin in ssh sshpass awk sed sort; do
  command -v "$bin" >/dev/null || { echo "❌ $bin requis"; exit 1; }
done

read -rp "Nom/IP de l'équipement BIG-IP: " HOST
read -rp "Utilisateur SSH (compte qui arrive en tmsh): " SSH_USER
read -s -rp "Mot de passe SSH: " SSH_PASS
echo

sshpass -p "$SSH_PASS" ssh -T \
  -o StrictHostKeyChecking=no \
  -o ConnectTimeout=15 \
  -o LogLevel=Error \
  "${SSH_USER}@${HOST}" "run util bash -s" <<'REMOTE_BASH'
set -euo pipefail

trim() {
  local s="$1"
  s="${s#"${s%%[![:space:]]*}"}"
  s="${s%"${s##*[![:space:]]}"}"
  printf "%s" "$s"
}

first_availability_from_show() {
  local line val
  while IFS= read -r line; do
    case "$line" in
      *Availability*:* )
        val="${line#*:}"
        val="$(trim "$val")"
        [[ -n "$val" ]] && { printf "%s" "$val"; return 0; }
        ;;
    esac
  done
  printf "UNKNOWN"
  return 0
}

get_partitions() {
  tmsh -c "list auth partition one-line" \
  | awk '$1=="auth" && $2=="partition" {print $3}' \
  | sed '/^$/d' \
  | sort -u
}

# ---------- VS ----------
get_vs_list() {
  local P="$1"
  tmsh -c "cd /${P}; list ltm virtual recursive one-line" 2>/dev/null \
  | awk '$1=="ltm" && $2=="virtual" {print $3}'
}

get_vs_availability() {
  local P="$1" VS="$2"
  tmsh -c "cd /${P}; show ltm virtual ${VS}" 2>/dev/null | first_availability_from_show
}

# ---------- POOLS ----------
get_pool_list() {
  local P="$1"
  tmsh -c "cd /${P}; list ltm pool recursive one-line" 2>/dev/null \
  | awk '$1=="ltm" && $2=="pool" {print $3}'
}

get_pool_availability() {
  local P="$1" POOL="$2"
  tmsh -c "cd /${P}; show ltm pool ${POOL}" 2>/dev/null | first_availability_from_show
}

# Members parser ROBUST (tolérant + fallback)
get_pool_members_status() {
  local P="$1" POOL="$2"
  local line member="" status="" val=""

  shopt -s nocasematch

  local RAW
  RAW="$(tmsh -c "cd /${P}; show ltm pool ${POOL} members" 2>/dev/null || true)"

  while IFS= read -r line; do
    if [[ "$line" == *"LTM::Pool Member:"* ]]; then
      if [[ -n "$member" && -z "$status" ]]; then
        printf "%s ; UNKNOWN\n" "$member"
      fi
      member="${line#*LTM::Pool Member:}"
      member="$(trim "$member")"
      status=""
      continue
    fi

    if [[ -n "$member" ]]; then
      if [[ "$line" == *"Availability"*:* ]]; then
        val="${line#*:}"
        val="$(trim "$val")"
        status="${val:-UNKNOWN}"
      elif [[ "$line" == *"State"*:* && -z "$status" ]]; then
        val="${line#*:}"
        val="$(trim "$val")"
        status="${val:-UNKNOWN}"
      elif [[ "$line" == *"Session"*:* && -z "$status" ]]; then
        val="${line#*:}"
        val="$(trim "$val")"
        status="${val:-UNKNOWN}"
      fi

      if [[ -n "$status" ]]; then
        printf "%s ; %s\n" "$member" "$status"
        member=""
        status=""
      fi
    fi
  done <<< "$RAW"

  if [[ -n "$member" && -z "$status" ]]; then
    printf "%s ; UNKNOWN\n" "$member"
  fi

  if ! grep -qi "LTM::Pool Member:" <<< "$RAW"; then
    echo "__FALLBACK__"
    printf "%s\n" "$RAW" | grep -Ei "Pool Member|Availability|State|Session" || true
  fi

  shopt -u nocasematch
}

# ---------- NODES ----------
get_node_list() {
  local P="$1"
  tmsh -c "cd /${P}; list ltm node recursive one-line" 2>/dev/null \
  | awk '$1=="ltm" && $2=="node" {print $3}'
}

get_node_availability() {
  local P="$1" NODE="$2"
  tmsh -c "cd /${P}; show ltm node ${NODE}" 2>/dev/null | first_availability_from_show
}

# ---------- MAIN ----------
PARTS="$(get_partitions || true)"
if [[ -z "${PARTS:-}" ]]; then
  echo "❌ Aucune partition visible (droits insuffisants ?) ou sortie vide."
  exit 1
fi

while IFS= read -r P || [[ -n "$P" ]]; do
  [[ -z "$P" ]] && continue

  echo "===== /$P ====="

  # VS
  echo "-- Virtual Servers"
  VS_LIST="$(get_vs_list "$P" || true)"
  if [[ -z "${VS_LIST:-}" ]]; then
    echo "(0 VS visibles dans /$P)"
  else
    while IFS= read -r VS || [[ -n "$VS" ]]; do
      [[ -z "$VS" ]] && continue
      AVAIL="$(get_vs_availability "$P" "$VS")"
      printf "%s ; %s\n" "$VS" "$AVAIL"
    done <<< "$VS_LIST"
  fi

  echo

  # Pools + Members
  echo "-- Pools"
  POOL_LIST="$(get_pool_list "$P" || true)"
  if [[ -z "${POOL_LIST:-}" ]]; then
    echo "(0 Pools visibles dans /$P)"
  else
    while IFS= read -r POOL || [[ -n "$POOL" ]]; do
      [[ -z "$POOL" ]] && continue

      PAVAIL="$(get_pool_availability "$P" "$POOL")"
      printf "%s ; %s\n" "$POOL" "$PAVAIL"

      MEMBERS="$(get_pool_members_status "$P" "$POOL" || true)"
      if [[ -z "${MEMBERS:-}" ]]; then
        echo "  (0 members ou statut non lisible)"
      else
        if grep -q "^__FALLBACK__$" <<< "$MEMBERS"; then
          echo "  (format members différent — extrait brut ci-dessous)"
          while IFS= read -r l || [[ -n "$l" ]]; do
            [[ "$l" == "__FALLBACK__" ]] && continue
            [[ -z "$l" ]] && continue
            printf "  %s\n" "$l"
          done <<< "$MEMBERS"
        else
          while IFS= read -r l || [[ -n "$l" ]]; do
            [[ -z "$l" ]] && continue
            printf "  %s\n" "$l"
          done <<< "$MEMBERS"
        fi
      fi

      echo
    done <<< "$POOL_LIST"
  fi

  echo

  # Nodes
  echo "-- Nodes"
  NODE_LIST="$(get_node_list "$P" || true)"
  if [[ -z "${NODE_LIST:-}" ]]; then
    echo "(0 Nodes visibles dans /$P)"
  else
    while IFS= read -r NODE || [[ -n "$NODE" ]]; do
      [[ -z "$NODE" ]] && continue
      NAVAIL="$(get_node_availability "$P" "$NODE")"
      printf "%s ; %s\n" "$NODE" "$NAVAIL"
    done <<< "$NODE_LIST"
  fi

  echo
done <<< "$PARTS"
REMOTE_BASH
