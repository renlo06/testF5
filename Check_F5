#!/usr/bin/env bash
set -euo pipefail

#######################################
# CONFIG
#######################################
BASE_DIR="./checks"
TS=$(date +%Y%m%d-%H%M%S)

for bin in ssh sshpass awk sed sort date mkdir; do
  command -v "$bin" >/dev/null || { echo "‚ùå $bin requis"; exit 1; }
done

read -rp "Nom/IP de l'√©quipement BIG-IP: " HOST
read -rp "Utilisateur SSH (compte qui arrive en tmsh): " SSH_USER
read -s -rp "Mot de passe SSH: " SSH_PASS
echo

#######################################
# DIRECTORY STRUCTURE
#######################################
HOST_DIR="${BASE_DIR}/${TS}/${HOST}"
mkdir -p "$HOST_DIR"

OUTPUT_FILE="${HOST_DIR}/check_LTM_ASM_AFM.txt"

echo "üìÅ R√©sultat stock√© dans : $OUTPUT_FILE"
echo

#######################################
# REMOTE EXECUTION
#######################################
sshpass -p "$SSH_PASS" ssh -T \
  -o StrictHostKeyChecking=no \
  -o ConnectTimeout=15 \
  -o LogLevel=Error \
  "${SSH_USER}@${HOST}" "run util bash -s" <<'REMOTE_BASH' > "$OUTPUT_FILE"

set -euo pipefail

trim() {
  local s="$1"
  s="${s#"${s%%[![:space:]]*}"}"
  s="${s%"${s##*[![:space:]]}"}"
  printf "%s" "$s"
}

first_availability_from_show() {
  local line val
  while IFS= read -r line; do
    case "$line" in
      *Availability*:* )
        val="${line#*:}"
        val="$(trim "$val")"
        [[ -n "$val" ]] && { printf "%s" "$val"; return 0; }
        ;;
    esac
  done
  printf "UNKNOWN"
}

echo "########################################"
echo "BIG-IP CHECK"
echo "Date : $(date)"
echo "########################################"
echo

########################################
# ASM
########################################
echo "===== ASM POLICIES ====="
tmsh -c "list asm policy recursive" 2>/dev/null | grep "asm policy" || echo "Aucune policy ASM"
echo

########################################
# AFM
########################################
echo "===== AFM FIREWALL POLICIES ====="
tmsh -c "list security firewall policy recursive" 2>/dev/null | grep "policy" || echo "Aucune policy AFM"
echo

########################################
# LTM (ALL PARTITIONS)
########################################
PARTS=$(tmsh -c "list auth partition one-line" | awk '$1=="auth"{print $3}')

for P in $PARTS; do
  echo "====================================="
  echo "PARTITION : /$P"
  echo "====================================="
  echo

  echo "-- Virtual Servers"
  tmsh -c "cd /${P}; list ltm virtual recursive one-line" 2>/dev/null || true
  echo

  echo "-- Pools"
  tmsh -c "cd /${P}; list ltm pool recursive one-line" 2>/dev/null || true
  echo

  echo "-- Nodes"
  tmsh -c "cd /${P}; list ltm node recursive one-line" 2>/dev/null || true
  echo
done

REMOTE_BASH

echo "‚úÖ Check termin√©"
echo "üìÑ Fichier g√©n√©r√© : $OUTPUT_FILE"
