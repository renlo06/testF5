#!/usr/bin/env bash
set -euo pipefail

for bin in ssh sshpass awk sed sort; do
  command -v "$bin" >/dev/null || { echo "❌ $bin requis"; exit 1; }
done

read -rp "Nom/IP de l'équipement BIG-IP: " HOST
read -rp "Utilisateur SSH (compte qui arrive en tmsh): " SSH_USER
read -s -rp "Mot de passe SSH: " SSH_PASS
echo

sshpass -p "$SSH_PASS" ssh -T \
  -o StrictHostKeyChecking=no \
  -o ConnectTimeout=15 \
  -o LogLevel=Error \
  "${SSH_USER}@${HOST}" "run util bash -s" <<'REMOTE_BASH'
set -euo pipefail

get_partitions() {
  tmsh -c "list auth partition one-line" \
  | awk '$1=="auth" && $2=="partition" {print $3}' \
  | sed '/^$/d' \
  | sort -u
}

# ---------- VS ----------
get_vs_list() {
  local P="$1"
  tmsh -c "cd /${P}; list ltm virtual recursive one-line" 2>/dev/null \
  | awk '$1=="ltm" && $2=="virtual" {print $3}'
}

get_vs_availability() {
  local P="$1" VS="$2"
  local avail
  avail="$(
    tmsh -c "cd /${P}; show ltm virtual ${VS}" 2>/dev/null \
    | awk '
        $0 ~ /^[[:space:]]*Availability[[:space:]]*:/ {
          s=$0
          sub(/^[[:space:]]*Availability[[:space:]]*:[[:space:]]*/, "", s)
          gsub(/^[ \t]+|[ \t]+$/, "", s)
          print s
          exit
        }'
  )"
  [[ -n "${avail:-}" ]] && printf "%s" "$avail" || printf "UNKNOWN"
}

# ---------- POOLS ----------
get_pool_list() {
  local P="$1"
  tmsh -c "cd /${P}; list ltm pool recursive one-line" 2>/dev/null \
  | awk '$1=="ltm" && $2=="pool" {print $3}'
}

get_pool_availability() {
  local P="$1" POOL="$2"
  local avail
  avail="$(
    tmsh -c "cd /${P}; show ltm pool ${POOL}" 2>/dev/null \
    | awk '
        $0 ~ /^[[:space:]]*Availability[[:space:]]*:/ {
          s=$0
          sub(/^[[:space:]]*Availability[[:space:]]*:[[:space:]]*/, "", s)
          gsub(/^[ \t]+|[ \t]+$/, "", s)
          print s
          exit
        }'
  )"
  [[ -n "${avail:-}" ]] && printf "%s" "$avail" || printf "UNKNOWN"
}

# ✅ Members parser ROBUST (espaces variables + fallback State/Session)
get_pool_members_status() {
  local P="$1" POOL="$2"

  tmsh -c "cd /${P}; show ltm pool ${POOL} members" 2>/dev/null \
  | awk '
      BEGIN { member=""; }

      /^LTM::Pool Member:/ {
        member=$0
        sub(/^LTM::Pool Member:[[:space:]]*/, "", member)
        gsub(/^[ \t]+|[ \t]+$/, "", member)
        next
      }

      member != "" && $0 ~ /^[[:space:]]*Availability[[:space:]]*:/ {
        avail=$0
        sub(/^[[:space:]]*Availability[[:space:]]*:[[:space:]]*/, "", avail)
        gsub(/^[ \t]+|[ \t]+$/, "", avail)
        if (avail=="") avail="UNKNOWN"
        printf "%s ; %s\n", member, avail
        member=""
        next
      }

      # Fallback si Availability n'existe pas
      member != "" && $0 ~ /^[[:space:]]*State[[:space:]]*:/ {
        st=$0
        sub(/^[[:space:]]*State[[:space:]]*:[[:space:]]*/, "", st)
        gsub(/^[ \t]+|[ \t]+$/, "", st)
        if (st=="") st="UNKNOWN"
        printf "%s ; %s\n", member, st
        member=""
        next
      }

      member != "" && $0 ~ /^[[:space:]]*Session[[:space:]]*:/ {
        sess=$0
        sub(/^[[:space:]]*Session[[:space:]]*:[[:space:]]*/, "", sess)
        gsub(/^[ \t]+|[ \t]+$/, "", sess)
        if (sess=="") sess="UNKNOWN"
        printf "%s ; %s\n", member, sess
        member=""
        next
      }
    '
}

# ---------- MAIN ----------
PARTS="$(get_partitions || true)"
if [[ -z "${PARTS:-}" ]]; then
  echo "❌ Aucune partition visible (droits insuffisants ?) ou sortie vide."
  exit 1
fi

while IFS= read -r P || [[ -n "$P" ]]; do
  [[ -z "$P" ]] && continue

  echo "===== /$P ====="

  # VS
  echo "-- Virtual Servers"
  VS_LIST="$(get_vs_list "$P" || true)"
  if [[ -z "${VS_LIST:-}" ]]; then
    echo "(0 VS visibles dans /$P)"
  else
    while IFS= read -r VS || [[ -n "$VS" ]]; do
      [[ -z "$VS" ]] && continue
      AVAIL="$(get_vs_availability "$P" "$VS")"
      printf "%s ; %s\n" "$VS" "$AVAIL"
    done <<< "$VS_LIST"
  fi

  echo

  # Pools + Members
  echo "-- Pools"
  POOL_LIST="$(get_pool_list "$P" || true)"
  if [[ -z "${POOL_LIST:-}" ]]; then
    echo "(0 Pools visibles dans /$P)"
  else
    while IFS= read -r POOL || [[ -n "$POOL" ]]; do
      [[ -z "$POOL" ]] && continue

      PAVAIL="$(get_pool_availability "$P" "$POOL")"
      printf "%s ; %s\n" "$POOL" "$PAVAIL"

      MEMBERS="$(get_pool_members_status "$P" "$POOL" || true)"
      if [[ -z "${MEMBERS:-}" ]]; then
        echo "  (0 members ou statut non lisible)"
      else
        while IFS= read -r line || [[ -n "$line" ]]; do
          [[ -z "$line" ]] && continue
          printf "  %s\n" "$line"
        done <<< "$MEMBERS"
      fi

      echo
    done <<< "$POOL_LIST"
  fi

  echo
done <<< "$PARTS"
REMOTE_BASH
