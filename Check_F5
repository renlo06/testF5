#!/usr/bin/env bash
set -euo pipefail

DEVICES_FILE="devices.txt"
OUT_BASE="./inventory"
TS=$(date +%Y%m%d-%H%M%S)
TOP=10000

for bin in curl jq date; do
  command -v "$bin" >/dev/null || { echo "‚ùå $bin requis"; exit 1; }
done
[[ -f "$DEVICES_FILE" ]] || { echo "‚ùå Fichier √©quipements introuvable : $DEVICES_FILE"; exit 1; }
mkdir -p "$OUT_BASE"

read -p "Utilisateur API (ex: admin): " API_USER
read -s -p "Mot de passe API: " API_PASS
echo

AUTH=(-u "${API_USER}:${API_PASS}" -k -sS)

SUMMARY_CSV="${OUT_BASE}/summary_${TS}.csv"
SUMMARY_TXT="${OUT_BASE}/summary_${TS}.txt"

echo 'host,vs_total,vs_ok,vs_ko,vs_unknown,pools_total,pools_ok,pools_ko,pools_unknown,nodes_total,nodes_ok,nodes_ko,nodes_unknown,asm_policies_total' > "$SUMMARY_CSV"
{
  echo "Run: $TS"
  echo
} > "$SUMMARY_TXT"

stats_to_avail_map_jq='
  def key_to_fullpath:
    ( . | capture("~(?<p>[^~]+)~(?<n>[^/]+)")? )
    | if . == null then null else ("/" + .p + "/" + .n) end;

  def pick_avail($e):
    (
      $e.nestedStats.entries.availabilityState.description? //
      $e.nestedStats.entries.status_availabilityState.description? //
      $e.nestedStats.entries.status.description? //
      $e.nestedStats.entries.availability.description? //
      empty
    );

  reduce (.entries // {} | to_entries[]) as $it ({}; 
    ($it.key | key_to_fullpath) as $fp
    | if $fp == null then . else . + { ($fp): (pick_avail($it.value) // "UNKNOWN") } end
  )
'

count_status_jq='
  def is_ok($s):
    ($s | ascii_upcase | test("AVAILABLE|UP"));

  def status($s):
    if $s == null or $s == "UNKNOWN" then "UNKNOWN"
    elif is_ok($s) then "OK"
    else "KO" end;

  .items // [] as $items
  | ($items | length) as $total
  | ($items | map( status($avail[.fullPath]) ) ) as $st
  | [
      $total,
      ($st | map(select(.=="OK")) | length),
      ($st | map(select(.=="KO")) | length),
      ($st | map(select(.=="UNKNOWN")) | length)
    ] | @tsv
'

vs_csv_jq='
  (["fullPath","enabled","disabled","destination","ipProtocol","availability"] | @csv),
  (.items[]? | [
    .fullPath,
    (.enabled // ""),
    (.disabled // ""),
    (.destination // ""),
    (.ipProtocol // ""),
    ($avail[.fullPath] // "UNKNOWN")
  ] | @csv)
'

pools_csv_jq='
  (["fullPath","members","loadBalancingMode","availability"] | @csv),
  (.items[]? | [
    .fullPath,
    (.members // "" | tostring),
    (.loadBalancingMode // ""),
    ($avail[.fullPath] // "UNKNOWN")
  ] | @csv)
'

nodes_csv_jq='
  (["fullPath","address","availability"] | @csv),
  (.items[]? | [
    .fullPath,
    (.address // ""),
    ($avail[.fullPath] // "UNKNOWN")
  ] | @csv)
'

asm_csv_jq='
  (["name","id","fullPath"] | @csv),
  (.items[]? | [
    (.name // ""),
    (.id // ""),
    (.fullPath // "")
  ] | @csv)
'

echo
echo "üìã Inventaire BIG-IP (REST) ‚Äî CSV + synth√®se CSV/TXT"
echo "üìÖ Horodatage : $TS"
echo "üìÑ Synth√®se CSV : $SUMMARY_CSV"
echo "üìù Synth√®se TXT : $SUMMARY_TXT"
echo

while IFS= read -r LINE || [[ -n "$LINE" ]]; do
  HOST=$(echo "$LINE" | tr -d '\r' | xargs)
  [[ -z "$HOST" || "$HOST" =~ ^# ]] && continue

  HOST_DIR="${OUT_BASE}/${HOST}/${TS}"
  mkdir -p "$HOST_DIR"

  echo "======================================"
  echo "‚û°Ô∏è  BIG-IP : $HOST"
  echo "======================================"

  # VS
  echo "üîé VS"
  VS_CFG=$(curl "${AUTH[@]}" "https://${HOST}/mgmt/tm/ltm/virtual?\$select=fullPath,enabled,disabled,destination,ipProtocol&\$top=${TOP}")
  VS_STATS=$(curl "${AUTH[@]}" "https://${HOST}/mgmt/tm/ltm/virtual/stats?\$top=${TOP}" || echo '{}')
  VS_AVAIL=$(jq -c "$stats_to_avail_map_jq" <<<"$VS_STATS" 2>/dev/null || echo '{}')
  jq --argjson avail "$VS_AVAIL" -r "$vs_csv_jq" <<<"$VS_CFG" > "${HOST_DIR}/vs_inventory.csv"
  VS_COUNTS=$(jq --argjson avail "$VS_AVAIL" -r "$count_status_jq" <<<"$VS_CFG" 2>/dev/null || echo $'0\t0\t0\t0')
  IFS=$'\t' read -r VS_TOTAL VS_OK VS_KO VS_UNK <<<"$VS_COUNTS"

  # Pools
  echo "üîé Pools"
  POOL_CFG=$(curl "${AUTH[@]}" "https://${HOST}/mgmt/tm/ltm/pool?\$select=fullPath,members,loadBalancingMode&\$top=${TOP}")
  POOL_STATS=$(curl "${AUTH[@]}" "https://${HOST}/mgmt/tm/ltm/pool/stats?\$top=${TOP}" || echo '{}')
  POOL_AVAIL=$(jq -c "$stats_to_avail_map_jq" <<<"$POOL_STATS" 2>/dev/null || echo '{}')
  jq --argjson avail "$POOL_AVAIL" -r "$pools_csv_jq" <<<"$POOL_CFG" > "${HOST_DIR}/pools_inventory.csv"
  POOL_COUNTS=$(jq --argjson avail "$POOL_AVAIL" -r "$count_status_jq" <<<"$POOL_CFG" 2>/dev/null || echo $'0\t0\t0\t0')
  IFS=$'\t' read -r POOL_TOTAL POOL_OK POOL_KO POOL_UNK <<<"$POOL_COUNTS"

  # Nodes
  echo "üîé Nodes"
  NODE_CFG=$(curl "${AUTH[@]}" "https://${HOST}/mgmt/tm/ltm/node?\$select=fullPath,address&\$top=${TOP}")
  NODE_STATS=$(curl "${AUTH[@]}" "https://${HOST}/mgmt/tm/ltm/node/stats?\$top=${TOP}" || echo '{}')
  NODE_AVAIL=$(jq -c "$stats_to_avail_map_jq" <<<"$NODE_STATS" 2>/dev/null || echo '{}')
  jq --argjson avail "$NODE_AVAIL" -r "$nodes_csv_jq" <<<"$NODE_CFG" > "${HOST_DIR}/nodes_inventory.csv"
  NODE_COUNTS=$(jq --argjson avail "$NODE_AVAIL" -r "$count_status_jq" <<<"$NODE_CFG" 2>/dev/null || echo $'0\t0\t0\t0')
  IFS=$'\t' read -r NODE_TOTAL NODE_OK NODE_KO NODE_UNK <<<"$NODE_COUNTS"

  # ASM
  echo "üîé ASM Policies"
  ASM_JSON=$(curl "${AUTH[@]}" "https://${HOST}/mgmt/tm/asm/policies?\$select=name,id,fullPath&\$top=${TOP}" || echo '{}')
  jq -r "$asm_csv_jq" <<<"$ASM_JSON" > "${HOST_DIR}/asm_policies.csv"
  ASM_TOTAL=$(jq -r '(.items // []) | length' <<<"$ASM_JSON")

  # Summary CSV
  echo "${HOST},${VS_TOTAL},${VS_OK},${VS_KO},${VS_UNK},${POOL_TOTAL},${POOL_OK},${POOL_KO},${POOL_UNK},${NODE_TOTAL},${NODE_OK},${NODE_KO},${NODE_UNK},${ASM_TOTAL}" \
    >> "$SUMMARY_CSV"

  # Summary TXT (UP/DOWN/UNKNOWN)
  {
    echo "Host: $HOST"
    echo "  VS    : total=${VS_TOTAL}  up=${VS_OK}  down=${VS_KO}  unknown=${VS_UNK}"
    echo "  Pools : total=${POOL_TOTAL}  up=${POOL_OK}  down=${POOL_KO}  unknown=${POOL_UNK}"
    echo "  Nodes : total=${NODE_TOTAL}  up=${NODE_OK}  down=${NODE_KO}  unknown=${NODE_UNK}"
    echo "  ASM Policies: total=${ASM_TOTAL}"
    echo
  } >> "$SUMMARY_TXT"

  echo "‚úÖ Export termin√© pour $HOST"
  echo
done < "$DEVICES_FILE"

echo "üèÅ Termin√©"
echo "üìÑ Synth√®se CSV : $SUMMARY_CSV"
echo "üìù Synth√®se TXT : $SUMMARY_TXT"
