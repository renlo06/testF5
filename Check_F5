#!/usr/bin/env bash
set -euo pipefail

#######################################
# CONFIG
#######################################
DEVICES_FILE="devices.txt"
BASE_DIR="./audit"

#######################################
# PRECHECKS
#######################################
for bin in ssh sshpass date; do
  command -v "$bin" >/dev/null || {
    echo "‚ùå $bin requis"
    exit 1
  }
done

[[ -f "$DEVICES_FILE" ]] || {
  echo "‚ùå Fichier √©quipements introuvable : $DEVICES_FILE"
  exit 1
}

#######################################
# INPUTS
#######################################
read -p "Utilisateur SSH (root ou admin): " SSH_USER
read -s -p "Mot de passe SSH: " SSH_PASS
echo

#######################################
# DATE
#######################################
DATE=$(date +%Y%m%d-%H%M%S)

#######################################
# COMMAND DEFINITIONS
#######################################
declare -A COMMANDS
declare -A FILES

COMMANDS[VS]='tmsh -c "cd /; show ltm virtual recursive" | grep "LTM::Virtual\|Availability"'
FILES[VS]='vs'

COMMANDS[POOL]='tmsh -c "cd /; show ltm pool recursive members" | grep "LTM::Pool\|Availability"'
FILES[POOL]='pools'

COMMANDS[NODE]='tmsh -c "cd /; show ltm node recursive" | grep "LTM::Node\|Availability"'
FILES[NODE]='nodes'

COMMANDS[ASM_POLICY]='tmsh -c "cd /; list asm policy recursive" | grep "asm policy"'
FILES[ASM_POLICY]='asm_policies'

#######################################
# FUNCTIONS
#######################################
run_tmsh_cmd() {
  local HOST="$1"
  local CMD="$2"
  local OUT_FILE="$3"

  sshpass -p "$SSH_PASS" ssh \
    -o StrictHostKeyChecking=no \
    -o ConnectTimeout=15 \
    -o LogLevel=Error \
    "$SSH_USER@$HOST" \
    "bash -lc \"$CMD\"" \
    > "$OUT_FILE" 2>>"$LOG_FILE"
}

#######################################
# MAIN LOOP
#######################################
echo
echo "üß™ Audit BIG-IP ‚Äì VS / Pools / Nodes / ASM"
echo "Date : $DATE"
echo

while IFS= read -r LINE || [[ -n "$LINE" ]]; do
  HOST=$(echo "$LINE" | tr -d '\r' | xargs)
  [[ -z "$HOST" || "$HOST" =~ ^# ]] && continue

  HOST_DIR="${BASE_DIR}/${HOST}/${DATE}"
  LOG_FILE="${HOST_DIR}/errors.log"

  mkdir -p "$HOST_DIR"

  echo "======================================"
  echo "‚û°Ô∏è  BIG-IP : $HOST"
  echo "üìÅ Dossier : $HOST_DIR"
  echo "======================================"

  for KEY in "${!COMMANDS[@]}"; do
    FILE_NAME="${FILES[$KEY]}_${DATE}.txt"
    OUT_FILE="${HOST_DIR}/${FILE_NAME}"

    echo "üîç Collecte ${KEY}"
    run_tmsh_cmd "$HOST" "${COMMANDS[$KEY]}" "$OUT_FILE"

    if [[ -s "$OUT_FILE" ]]; then
      echo "‚úÖ ${KEY} ‚Üí $FILE_NAME"
    else
      echo "‚ö†Ô∏è  ${KEY} ‚Üí fichier vide"
    fi
  done

  echo
done < "$DEVICES_FILE"

echo "üéØ Audit termin√© pour tous les √©quipements"
